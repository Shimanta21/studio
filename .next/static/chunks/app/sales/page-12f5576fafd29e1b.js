(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[117],{38439:(e,t,a)=>{Promise.resolve().then(a.bind(a,48339))},48339:(e,t,a)=>{"use strict";a.d(t,{default:()=>H});var s=a(95155),r=a(12115),l=a(62177),n=a(90221),c=a(55594),i=a(67785),d=a(30285),o=a(66695),m=a(75937),u=a(62523),x=a(14636),p=a(85511),h=a(59409),j=a(85127),f=a(55365),g=a(77740),N=a(75074),v=a(59434);a(54165);let y=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(g.uB,{ref:t,className:(0,v.cn)("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",a),...r})});y.displayName=g.uB.displayName;let b=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsxs)("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[(0,s.jsx)(N.A,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),(0,s.jsx)(g.uB.Input,{ref:t,className:(0,v.cn)("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",a),...r})]})});b.displayName=g.uB.Input.displayName;let w=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(g.uB.List,{ref:t,className:(0,v.cn)("max-h-[300px] overflow-y-auto overflow-x-hidden",a),...r})});w.displayName=g.uB.List.displayName;let I=r.forwardRef((e,t)=>(0,s.jsx)(g.uB.Empty,{ref:t,className:"py-6 text-center text-sm",...e}));I.displayName=g.uB.Empty.displayName;let S=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(g.uB.Group,{ref:t,className:(0,v.cn)("overflow-hidden p-1 text-popover-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",a),...r})});S.displayName=g.uB.Group.displayName,r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(g.uB.Separator,{ref:t,className:(0,v.cn)("-mx-1 h-px bg-border",a),...r})}).displayName=g.uB.Separator.displayName;let A=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(g.uB.Item,{ref:t,className:(0,v.cn)("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none aria-selected:bg-accent aria-selected:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...r})});A.displayName=g.uB.Item.displayName;var k=a(83013),B=a(34301),R=a(51920),C=a(21887),q=a(10518),L=a(77223),D=a(50172),P=a(73672),_=a(74601),E=a(31949),F=a(87481),M=a(34477);let V=(0,M.createServerReference)("40c953ede8c138aa92e972c1604f4839ba54397e62",M.callServer,void 0,M.findSourceMapURL,"generateSalesNotification"),T=c.Ik({productName:c.Yj().min(1,{message:"Please select a product."}),productId:c.Yj().min(1,{message:"Please select a batch."}),quantity:c.au.number().min(1,"Quantity must be at least 1."),price:c.au.number().optional()}),z=c.Ik({saleDate:c.p6({required_error:"A sale date is required."}),customerName:c.Yj().min(1,"Please select a customer."),items:c.YO(T).min(1,"Please add at least one product.")});function H(){let{products:e,addBulkSale:t,customers:a}=(0,i.n)(),{toast:c}=(0,F.dj)(),[g,N]=r.useState(null),[M,T]=r.useState({isLoading:!1,message:null,error:null}),[H,J]=r.useState(!1),O=(0,l.mN)({resolver:(0,n.u)(z),defaultValues:{saleDate:new Date,customerName:"",items:[{productName:"",productId:"",quantity:1,price:0}]}}),{fields:$,append:G,remove:W}=(0,l.jz)({control:O.control,name:"items"}),X=r.useMemo(()=>[...new Set(e.map(e=>e.name))],[e]),Y=O.watch("items").map(e=>e.productName),Z=async()=>{if(g){T({isLoading:!0,message:null,error:null});try{let e=await V({customerName:g.customerName,items:g.items.map(e=>({productName:e.productName,quantity:e.quantity,price:e.price})),totalAmount:g.totalAmount});T({isLoading:!1,message:e.notificationMessage,error:null})}catch(e){console.error(e),T({isLoading:!1,message:null,error:"Failed to generate notification."})}}};async function Q(a){let s=!1,r=a.items.map(e=>e.productId),l=r.filter((e,t)=>r.indexOf(e)!==t&&""!==e);if(l.length>0&&a.items.forEach((e,t)=>{l.includes(e.productId)&&(O.setError("items.".concat(t,".productId"),{type:"manual",message:"Duplicate batch selected."}),s=!0)}),a.items.forEach((t,a)=>{let r=e.find(e=>e.id===t.productId);r&&r.stockInHand<t.quantity&&(O.setError("items.".concat(a,".quantity"),{type:"manual",message:"Not enough stock. Only ".concat(r.stockInHand," available.")}),s=!0)}),!s)try{await t({customerName:a.customerName,saleDate:a.saleDate,items:a.items.map(t=>({productId:t.productId,quantity:t.quantity,price:e.find(e=>e.id===t.productId).price}))});let s=a.items.map(t=>{let a=e.find(e=>e.id===t.productId);return{productName:a.name,quantity:t.quantity,price:a.price,total:t.quantity*a.price}}),r=s.reduce((e,t)=>e+t.total,0);N({customerName:a.customerName,items:s,totalAmount:r}),T({isLoading:!1,message:null,error:null});let l=a.items.reduce((e,t)=>e+t.quantity,0);c({title:"Sales Recorded Successfully",description:"Recorded sales for ".concat(a.items.length," product(s), totaling ").concat(l," items for ").concat(a.customerName,".")}),O.reset({saleDate:new Date,customerName:"",items:[{productName:"",productId:"",quantity:1,price:0}]})}catch(e){c({variant:"destructive",title:"Failed to Record Sale",description:e.message||"An unexpected error occurred."})}}return(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-8 items-start",children:[(0,s.jsxs)(o.Zp,{className:"lg:col-span-3",children:[(0,s.jsxs)(o.aR,{children:[(0,s.jsxs)(o.ZB,{className:"flex items-center gap-2",children:[(0,s.jsx)(B.A,{}),"Record Sales"]}),(0,s.jsx)(o.BT,{children:"Add one or more products to record a bulk sale for a single customer. The inventory will be updated automatically."})]}),(0,s.jsx)(o.Wu,{children:(0,s.jsx)(m.lV,{...O,children:(0,s.jsxs)("form",{onSubmit:O.handleSubmit(Q),className:"space-y-8",children:[(0,s.jsxs)("div",{className:"grid md:grid-cols-2 gap-4 max-w-2xl",children:[(0,s.jsx)(m.zB,{control:O.control,name:"saleDate",render:e=>{let{field:t}=e;return(0,s.jsxs)(m.eI,{className:"flex flex-col",children:[(0,s.jsx)(m.lR,{children:"Date of Sale"}),(0,s.jsxs)(x.AM,{children:[(0,s.jsx)(x.Wv,{asChild:!0,children:(0,s.jsx)(m.MJ,{children:(0,s.jsxs)(d.$,{variant:"outline",className:(0,v.cn)("w-full pl-3 text-left font-normal",!t.value&&"text-muted-foreground"),children:[t.value?(0,k.GP)(t.value,"PPP"):(0,s.jsx)("span",{children:"Pick a date"}),(0,s.jsx)(R.A,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),(0,s.jsx)(x.hl,{className:"w-auto p-0",align:"start",children:(0,s.jsx)(p.V,{mode:"single",selected:t.value,onSelect:t.onChange,disabled:e=>e>new Date||e<new Date("1900-01-01"),initialFocus:!0})})]}),(0,s.jsx)(m.C5,{})]})}}),(0,s.jsx)(m.zB,{control:O.control,name:"customerName",render:e=>{var t;let{field:r}=e;return(0,s.jsxs)(m.eI,{className:"flex flex-col",children:[(0,s.jsx)(m.lR,{children:"Customer Name"}),(0,s.jsxs)(x.AM,{open:H,onOpenChange:J,children:[(0,s.jsx)(x.Wv,{asChild:!0,children:(0,s.jsx)(m.MJ,{children:(0,s.jsxs)(d.$,{variant:"outline",role:"combobox",className:(0,v.cn)("w-full justify-between",!r.value&&"text-muted-foreground"),children:[r.value?null==(t=a.find(e=>e.name===r.value))?void 0:t.name:"Select a customer",(0,s.jsx)(C.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),(0,s.jsx)(x.hl,{className:"w-[--radix-popover-trigger-width] p-0",align:"start",children:(0,s.jsxs)(y,{children:[(0,s.jsx)(b,{placeholder:"Search customers..."}),(0,s.jsxs)(w,{children:[(0,s.jsx)(I,{children:"No customer found."}),(0,s.jsx)(S,{children:a.map(e=>(0,s.jsxs)(A,{value:e.name,onSelect:()=>{O.setValue("customerName",e.name),J(!1)},children:[(0,s.jsx)(q.A,{className:(0,v.cn)("mr-2 h-4 w-4",e.name===r.value?"opacity-100":"opacity-0")}),e.name]},e.id))})]})]})})]}),(0,s.jsx)(m.C5,{})]})}})]}),(0,s.jsx)("div",{className:"space-y-4",children:$.map((t,a)=>{let r=O.watch("items.".concat(a,".productName")),l=e.filter(e=>e.name===r);return(0,s.jsxs)("div",{className:"flex items-start gap-4 p-4 border rounded-lg",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 flex-1",children:[(0,s.jsx)(m.zB,{control:O.control,name:"items.".concat(a,".productName"),render:e=>{let{field:t}=e;return(0,s.jsxs)(m.eI,{children:[(0,s.jsx)(m.lR,{children:"Product"}),(0,s.jsxs)(h.l6,{onValueChange:e=>{t.onChange(e),O.setValue("items.".concat(a,".productId"),""),O.setValue("items.".concat(a,".price"),0),O.clearErrors("items.".concat(a,".productId"))},value:t.value,children:[(0,s.jsx)(m.MJ,{children:(0,s.jsx)(h.bq,{children:(0,s.jsx)(h.yv,{placeholder:"Select a product"})})}),(0,s.jsx)(h.gC,{children:X.map(e=>(0,s.jsx)(h.eb,{value:e,disabled:Y.includes(e)&&t.value!==e,children:e},e))})]}),(0,s.jsx)(m.C5,{})]})}}),(0,s.jsx)(m.zB,{control:O.control,name:"items.".concat(a,".productId"),render:t=>{let{field:n}=t;return(0,s.jsxs)(m.eI,{children:[(0,s.jsx)(m.lR,{children:"Batch Number"}),(0,s.jsxs)(h.l6,{onValueChange:t=>{n.onChange(t);let s=e.find(e=>e.id===t);O.setValue("items.".concat(a,".price"),null==s?void 0:s.price)},value:n.value,disabled:!r,children:[(0,s.jsx)(m.MJ,{children:(0,s.jsx)(h.bq,{children:(0,s.jsx)(h.yv,{placeholder:"Select a batch"})})}),(0,s.jsx)(h.gC,{children:l.map(e=>(0,s.jsxs)(h.eb,{value:e.id,disabled:0===e.stockInHand,children:[e.batchNumber," (",e.stockInHand," in stock)"]},e.id))})]}),(0,s.jsx)(m.C5,{})]})}}),(0,s.jsx)(m.zB,{control:O.control,name:"items.".concat(a,".quantity"),render:e=>{let{field:t}=e;return(0,s.jsxs)(m.eI,{children:[(0,s.jsx)(m.lR,{children:"Quantity"}),(0,s.jsx)(m.MJ,{children:(0,s.jsx)(u.p,{type:"number",placeholder:"1",...t})}),(0,s.jsx)(m.C5,{})]})}}),(0,s.jsx)(m.zB,{control:O.control,name:"items.".concat(a,".price"),render:e=>{let{field:t}=e;return(0,s.jsxs)(m.eI,{children:[(0,s.jsx)(m.lR,{children:"Price (₹)"}),(0,s.jsx)(m.MJ,{children:(0,s.jsx)(u.p,{type:"number",placeholder:"0.00",disabled:!0,value:t.value||0})}),(0,s.jsx)(m.C5,{})]})}})]}),(0,s.jsxs)(d.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>W(a),disabled:$.length<=1,className:"mt-8 text-destructive hover:bg-destructive/10",children:[(0,s.jsx)(L.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Remove item"})]})]},t.id)})}),(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)(d.$,{type:"button",variant:"outline",onClick:()=>G({productName:"",productId:"",quantity:1,price:0}),children:[(0,s.jsx)(B.A,{className:"mr-2 h-4 w-4"}),"Add Another Product"]}),(0,s.jsx)(d.$,{type:"submit",disabled:O.formState.isSubmitting,children:O.formState.isSubmitting?"Recording Sales...":"Record All Sales"})]})]})})})]}),(0,s.jsx)("div",{className:"lg:col-span-2 space-y-4",children:g&&(0,s.jsxs)(o.Zp,{children:[(0,s.jsxs)(o.aR,{children:[(0,s.jsx)(o.ZB,{children:"Sale Summary"}),(0,s.jsxs)(o.BT,{children:["For customer: ",(0,s.jsx)("strong",{children:g.customerName})]})]}),(0,s.jsxs)(o.Wu,{children:[(0,s.jsxs)(j.XI,{children:[(0,s.jsx)(j.A0,{children:(0,s.jsxs)(j.Hj,{children:[(0,s.jsx)(j.nd,{children:"Item"}),(0,s.jsx)(j.nd,{className:"text-center",children:"Qty"}),(0,s.jsx)(j.nd,{className:"text-right",children:"Total"})]})}),(0,s.jsx)(j.BF,{children:g.items.map((e,t)=>(0,s.jsxs)(j.Hj,{children:[(0,s.jsx)(j.nA,{children:e.productName}),(0,s.jsx)(j.nA,{className:"text-center",children:e.quantity}),(0,s.jsxs)(j.nA,{className:"text-right",children:["₹",e.total.toFixed(2)]})]},t))})]}),(0,s.jsxs)("div",{className:"text-right font-bold text-lg mt-4",children:["Grand Total: ₹",g.totalAmount.toFixed(2)]})]}),(0,s.jsxs)(o.wL,{className:"flex flex-col items-stretch gap-4",children:[(0,s.jsxs)(d.$,{onClick:Z,disabled:M.isLoading,children:[M.isLoading?(0,s.jsx)(D.A,{className:"animate-spin"}):(0,s.jsx)(P.A,{}),"Send Bill Notification"]}),M.message&&(0,s.jsxs)(f.Fc,{variant:"default",className:"bg-primary/10",children:[(0,s.jsx)(_.A,{className:"h-4 w-4 text-primary"}),(0,s.jsx)(f.XL,{className:"text-primary",children:"Generated Notification"}),(0,s.jsx)(f.TN,{className:"whitespace-pre-wrap",children:M.message})]}),M.error&&(0,s.jsxs)(f.Fc,{variant:"destructive",children:[(0,s.jsx)(E.A,{className:"h-4 w-4"}),(0,s.jsx)(f.XL,{children:"Error"}),(0,s.jsx)(f.TN,{children:M.error})]})]})]})})]})}},55365:(e,t,a)=>{"use strict";a.d(t,{Fc:()=>i,TN:()=>o,XL:()=>d});var s=a(95155),r=a(12115),l=a(74466),n=a(59434);let c=(0,l.F)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),i=r.forwardRef((e,t)=>{let{className:a,variant:r,...l}=e;return(0,s.jsx)("div",{ref:t,role:"alert",className:(0,n.cn)(c({variant:r}),a),...l})});i.displayName="Alert";let d=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("h5",{ref:t,className:(0,n.cn)("mb-1 font-medium leading-none tracking-tight",a),...r})});d.displayName="AlertTitle";let o=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,n.cn)("text-sm [&_p]:leading-relaxed",a),...r})});o.displayName="AlertDescription"}},e=>{var t=t=>e(e.s=t);e.O(0,[992,644,263,417,175,239,979,968,706,902,441,684,358],()=>t(38439)),_N_E=e.O()}]);